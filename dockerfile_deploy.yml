# Dockerfile for GraphRAG Application
FROM python:3.10-slim

# Set working directory
WORKDIR /app

# Install system dependencies
RUN apt-get update && apt-get install -y \
    build-essential \
    curl \
    software-properties-common \
    git \
    && rm -rf /var/lib/apt/lists/*

# Copy requirements first for better caching
COPY requirements.txt .

# Install Python dependencies
RUN pip install --no-cache-dir -r requirements.txt

# Copy application code
COPY . .

# Create .streamlit directory if it doesn't exist
RUN mkdir -p .streamlit

# Expose Streamlit port
EXPOSE 8501

# Health check
HEALTHCHECK CMD curl --fail http://localhost:8501/_stcore/health

# Run the application
ENTRYPOINT ["streamlit", "run", "app.py", "--server.port=8501", "--server.address=0.0.0.0"]

---
# docker-compose.yml
# Complete stack with Neo4j and Streamlit app

version: '3.8'

services:
  neo4j:
    image: neo4j:5.15-community
    container_name: graphrag-neo4j
    ports:
      - "7474:7474"  # HTTP
      - "7687:7687"  # Bolt
    environment:
      - NEO4J_AUTH=neo4j/your_password_here
      - NEO4J_PLUGINS=["apoc"]
      - NEO4J_dbms_security_procedures_unrestricted=apoc.*
      - NEO4J_dbms_memory_heap_max__size=2G
    volumes:
      - neo4j_data:/data
      - neo4j_logs:/logs
      - neo4j_import:/var/lib/neo4j/import
    networks:
      - graphrag-network
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider localhost:7474 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5

  streamlit:
    build: .
    container_name: graphrag-app
    ports:
      - "8501:8501"
    environment:
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USER=neo4j
      - NEO4J_PASSWORD=your_password_here
    volumes:
      - .:/app
      - ./combined_grants_small.csv:/app/combined_grants_small.csv
    depends_on:
      neo4j:
        condition: service_healthy
    networks:
      - graphrag-network
    restart: unless-stopped

volumes:
  neo4j_data:
  neo4j_logs:
  neo4j_import:

networks:
  graphrag-network:
    driver: bridge

---
# .dockerignore
# Files to exclude from Docker build

__pycache__/
*.py[cod]
*$py.class
*.so
.Python
env/
venv/
ENV/
build/
develop-eggs/
dist/
downloads/
eggs/
.eggs/
lib/
lib64/
parts/
sdist/
var/
wheels/
*.egg-info/
.installed.cfg
*.egg

# IDE
.vscode/
.idea/
*.swp
*.swo
*~

# OS
.DS_Store
Thumbs.db

# Logs
*.log

# Secrets
.streamlit/secrets.toml
.env

# Git
.git/
.gitignore

# Documentation
README.md
QUICKSTART.md
LICENSE

---
# Makefile
# Convenient commands for development and deployment

.PHONY: help install run docker-build docker-up docker-down ingest test clean

help: ## Show this help message
	@echo "GraphRAG System - Available Commands:"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | awk 'BEGIN {FS = ":.*?## "}; {printf "  \033[36m%-20s\033[0m %s\n", $$1, $$2}'

install: ## Install Python dependencies
	pip install -r requirements.txt

run: ## Run the Streamlit application
	streamlit run app.py

ingest: ## Run data ingestion script
	python scripts/ingest_data.py

embeddings: ## Generate vector embeddings
	python scripts/generate_embeddings.py

docker-build: ## Build Docker images
	docker-compose build

docker-up: ## Start all services with Docker
	docker-compose up -d
	@echo "Waiting for services to start..."
	@sleep 10
	@echo "Neo4j Browser: http://localhost:7474"
	@echo "Streamlit App: http://localhost:8501"

docker-down: ## Stop all Docker services
	docker-compose down

docker-logs: ## Show Docker logs
	docker-compose logs -f

docker-ingest: ## Run data ingestion in Docker
	docker-compose exec streamlit python scripts/ingest_data.py

docker-clean: ## Remove all Docker containers and volumes
	docker-compose down -v
	docker system prune -f

test: ## Run tests
	python -m pytest tests/

clean: ## Clean up temporary files
	find . -type d -name __pycache__ -exec rm -rf {} +
	find . -type f -name "*.pyc" -delete
	find . -type f -name "*.pyo" -delete
	find . -type d -name "*.egg-info" -exec rm -rf {} +

setup: ## Complete setup (install + ingest)
	make install
	make ingest
	@echo "Setup complete! Run 'make run' to start the application."

dev: ## Start development environment
	docker-compose up neo4j -d
	@echo "Neo4j started. Run 'make run' in another terminal."

prod: ## Start production deployment
	make docker-build
	make docker-up
	@echo "Production environment started!"

---
# deployment/kubernetes.yaml
# Kubernetes deployment configuration (optional)

apiVersion: v1
kind: Namespace
metadata:
  name: graphrag

---
apiVersion: v1
kind: Secret
metadata:
  name: graphrag-secrets
  namespace: graphrag
type: Opaque
stringData:
  neo4j-password: "your_password_here"
  anthropic-api-key: "your_api_key_here"

---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: neo4j
  namespace: graphrag
spec:
  serviceName: neo4j
  replicas: 1
  selector:
    matchLabels:
      app: neo4j
  template:
    metadata:
      labels:
        app: neo4j
    spec:
      containers:
      - name: neo4j
        image: neo4j:5.15-community
        ports:
        - containerPort: 7474
          name: http
        - containerPort: 7687
          name: bolt
        env:
        - name: NEO4J_AUTH
          value: "neo4j/$(NEO4J_PASSWORD)"
        - name: NEO4J_PASSWORD
          valueFrom:
            secretKeyRef:
              name: graphrag-secrets
              key: neo4j-password
        volumeMounts:
        - name: neo4j-data
          mountPath: /data
  volumeClaimTemplates:
  - metadata:
      name: neo4j-data
    spec:
      accessModes: [ "ReadWriteOnce" ]
      resources:
        requests:
          storage: 10Gi

---
apiVersion: v1
kind: Service
metadata:
  name: neo4j
  namespace: graphrag
spec:
  selector:
    app: neo4j
  ports:
  - name: http
    port: 7474
  - name: bolt
    port: 7687

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: streamlit-app
  namespace: graphrag
spec:
  replicas: 2
  selector:
    matchLabels:
      app: streamlit
  template:
    metadata:
      labels:
        app: streamlit
    spec:
      containers:
      - name: streamlit
        image: your-registry/graphrag-app:latest
        ports:
        - containerPort: 8501
        env:
        - name: NEO4J_URI
          value: "bolt://neo4j:7687"
        - name: NEO4J_USER
          value: "neo4j"
        - name: NEO4J_PASSWORD
          valueFrom:
            secretKeyRef:
              name: graphrag-secrets
              key: neo4j-password

---
apiVersion: v1
kind: Service
metadata:
  name: streamlit
  namespace: graphrag
spec:
  selector:
    app: streamlit
  ports:
  - port: 80
    targetPort: 8501
  type: LoadBalancer
